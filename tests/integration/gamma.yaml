einsum:
  declaration:
    A: [K, M]
    B: [K, N]
    T: [K, M, N]
    Z: [M, N]
  expressions:
    - T[k,m,n] = take(A[k,m], B[k,n], 1)
    - Z[m,n] = T[k,m,n]*A[k,m]
mapping:
  rank-order:
    A: [M, K]
    B: [K, N]
    T: [M, K, N]
    Z: [M, N]
  partitioning:
    T:
      M: [uniform_occupancy(A.32)]
      K: [uniform_occupancy(A.64)]
    Z:
      M: [uniform_occupancy(A.32)]
      K: [uniform_occupancy(A.64)]
  loop-order:
    T: [M1, M0, K1, K0, N]
    Z: [M1, M0, K1, N, K0]
  spacetime:
    T:
      space: [M0, K1]
      time: [M1, K0, N]
    Z:
      space: [M0, K1]
      time: [M1, N, K0]
format:
  A:
    M:
      format: U
      pbits: 32
    K:
      format: C
      cbits: 32
      pbits: 64
  B:
    K:
      format: U
      pbits: 32
    N:
      format: C
      cbits: 32
      pbits: 64
  T:
    M:
      format: C
      cbits: 32
    K:
      format: C
    N:
      format: C
      cbits: 32
      pbits: 64
  Z:
    M:
      format: U
      pbits: 32
    N:
      format: C
      cbits: 32
      pbits: 64
architecture:
  Accelerator:
  - name: System
    attributes:
      clock_frequency: 1000000000 # 1 GHz = 1 * 10^9 Hz = 1000000000 Hz
    local:
    - name: MainMemory
      class: DRAM
      attributes:
        # 128 GB/s = 128 * 2^30 * 8 bits/s
        bandwidth: 1099511627776
    subtree:
    - name: Chip
      local:
      - name: FiberCache
        class: Cache
        attributes:
          width: 64 # Block size is not mentioned in the paper; minimum correct value
          depth: 393216 # 3 MB / 8B = 393216 lines
      subtree:
      - name: PE[0..31] # 32 PEs
        local:
        - name: Stage0RegFile
          class: SRAM
        - name: Stage1RegFile
          class: SRAM
        subtree:
        - name: Stage0
          local:
          - name: Intersect
            class: Intersector
            attributes:
              type: leader-follower
        - name: Stage0to1
          local:
          - name: HighRadixMerger
            class: Merger
            attributes:
              inputs: 64
              comparator_radix: 64
              outputs: 1
              order: fifo
              reduce: False
        - name: Stage1
          local:
          - name: FPMul
            class: compute
            attributes:
              op: mul
          - name: FPAdd
            class: compute
            attributes:
              op: add
bindings:
  T:
  - config: Accelerator
  - component: MainMemory
    bindings:
    - tensor: A
      rank: M
      type: payload
    - tensor: A
      rank: K
      type: coord
    - tensor: A
      rank: K
      type: payload
    - tensor: B
      rank: K
      type: payload
    - tensor: B
      rank: N
      type: coord
    - tensor: B
      rank: N
      type: payload
  - component: FiberCache
    bindings:
    - tensor: B
      rank: K
      type: payload
    - tensor: B
      rank: N
      type: coord
    - tensor: B
      rank: N
      type: payload
  - component: Stage0RegFile
    bindings:
    - tensor: A
      rank: M
      type: payload
    - tensor: A
      rank: K
      type: coord
    - tensor: B
      rank: K
      type: payload
    - tensor: B
      rank: N
      type: coord
    - tensor: B
      rank: N
      type: payload
    - tensor: T
      rank: M
      type: coord
    - tensor: T
      rank: N
      type: coord
    - tensor: T
      rank: N
      type: payload
  - component: Intersection
    bindings:
    - rank: K0
      leader: A
  Z:
  - config: Accelerator
  - component: MainMemory
    bindings:
    - tensor: A
      rank: M
      type: payload
    - tensor: A
      rank: K
      type: coord
    - tensor: A
      rank: K
      type: payload
    - tensor: Z
      rank: M
      type: payload
    - tensor: Z
      rank: N
      type: coord
    - tensor: Z
      rank: N
      type: payload
  - component: Stage1RegFile
    bindings:
    - tensor: A
      rank: K
      type: payload
    - tensor: T
      rank: M
      type: coord
    - tensor: T
      rank: N
      type: coord
    - tensor: T
      rank: N
      type: payload
    - tensor: Z
      rank: M
      type: coord
    - tensor: Z
      rank: N
      type: coord
    - tensor: Z
      rank: N
      type: payload
  - component: HighRadixMerger
    bindings:
    - op: merge
      tensor: T
  - component: FPMul
    bindings:
    - op: mul
  - component: FPAdd
    bindings:
    - op: add
